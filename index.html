<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注音拼音練習 App</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --blue: #e0f2fe; --green: #dcfce7; --gray: #f3f4f6; }
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; }
        .container { display: grid; grid-template-columns: 3fr 1fr; gap: 10px; width: 95vw; height: 90vh; margin-top: 10px; }
        
        /* 故事區 */
        .main-area { background: var(--blue); border-radius: 20px; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .story-img { width: 100%; max-height: 250px; object-fit: contain; background: white; border-radius: 10px; }
        .dialog-box { width: 80%; background: white; margin-top: 20px; padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #333; }

        /* 作答區 */
        .answer-area { background: var(--green); border-radius: 20px; padding: 20px; margin-top: 10px; display: flex; align-items: center; gap: 20px; }
        .drop-zone { width: 200px; height: 200px; background: #ccc; border: 3px dashed #666; display: flex; flex-wrap: wrap; align-content: center; justify-content: center; }
        
        /* 符號區 */
        .symbol-wall { border-left: 1px solid #ddd; padding: 10px; overflow-y: auto; }
        .symbol-item { display: inline-block; padding: 8px 12px; margin: 3px; background: white; border: 1px solid #ccc; cursor: grab; border-radius: 5px; }
        .type-label { font-weight: bold; margin-top: 10px; color: #555; border-bottom: 2px solid #333; }
        
        .btn { padding: 10px 20px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        .btn-ok { background: #fbbf24; }
        .btn-re { background: #ef4444; color: white; }
    </style>
</head>
<body>

<div id="app">
    <div v-if="!currentStory" style="padding: 50px;">
        <h2>選擇故事</h2>
        <button v-for="s in stories" @click="selectStory(s)" class="btn">{{ s.title }}</button>
    </div>

    <div v-else class="container">
        <div>
            <div class="main-area">
                <img :src="currentScene.image" class="story-img">
                <div class="dialog-box">對話框：{{ currentScene.dialogue }}</div>
            </div>

            <div class="answer-area">
                <div style="font-size: 2rem;">{{ currentWord.word }} <button @click="playSound">▶️</button></div>
                <div id="targetZone" class="drop-zone">
                    <div v-for="s in currentAttempt" class="symbol-item">{{ s }}</div>
                </div>
                <div>
                    <button @click="resetAttempt" class="btn btn-re">RE</button>
                    <button @click="checkAnswer" class="btn btn-ok">OK</button>
                </div>
                <div v-if="isCorrect">⭐</div>
            </div>
        </div>

        <div class="symbol-wall">
            <div class="type-label">聲母</div>
            <div v-for="s in symbols.initials" class="symbol-item" @click="addToAttempt(s)">{{ s }}</div>
            <div class="type-label">介/韻母</div>
            <div v-for="s in symbols.finals" class="symbol-item" @click="addToAttempt(s)">{{ s }}</div>
            <div class="type-label">音調</div>
            <div v-for="s in symbols.tones" class="symbol-item" @click="addToAttempt(s)">{{ s }}</div>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
    return {
        // 確認 ID 是這串：1XFFrUXyFBa-84wo6lbFR9Fz1ZEythXm2Z0HIQ2k5X7Y
        sheetId: '1XFFrUXyFBa-84wo6lbFR9Fz1ZEythXm2Z0HIQ2k5X7Y', 
        stories: [],
        currentStory: null,
        wordIndex: 0, // 記得加入這個，處理連續測驗
        attempt: [],
        isSuccess: false,
        // ... 其他符號定義不變 ...
    }
},
   // ... 前面 data 不變 ...
methods: {
async fetchData() {
        // 使用 CSV 格式抓取比較穩定
        const url = `https://docs.google.com/spreadsheets/d/${this.sheetId}/gviz/tq?tqx=out:csv&sheet=Sheet1`;
        try {
            const response = await fetch(url);
            const csvText = await response.text();
            
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    const rawData = results.data;
                    console.log("原始資料:", rawData); // 你可以在瀏覽器按 F12 檢查
                    
                    // 群組化邏輯：把相同 group_id 的字放在一起
                    const grouped = [];
                    rawData.forEach(item => {
                        if(!item.group_id) return; // 跳過空行
                        let existing = grouped.find(g => g.group_id === item.group_id);
                        if (existing) {
                            existing.words.push({ 
                                text: item.test_word, 
                                pinyin: item.correct_zhuyin 
                            });
                        } else {
                            grouped.push({
                                group_id: item.group_id,
                                story_title: item.story_title,
                                scene_img: item.scene_img,
                                dialogue: item.dialogue,
                                words: [{ 
                                    text: item.test_word, 
                                    pinyin: item.correct_zhuyin 
                                }]
                            });
                        }
                    });
                    this.stories = grouped;
                }
            });
        } catch (error) {
            console.error("抓取失敗:", error);
        }
    },
    startStory(s) {
        this.currentStory = s;
        this.wordIndex = 0; // 從第一個字開始
        this.resetTurn();
    },
    resetTurn() {
        this.attempt = [];
        this.isSuccess = false;
    },
    handlePick(s) {
        if (this.isSuccess) return;
        
        const currentTarget = this.currentStory.words[this.wordIndex];
        const correctArr = currentTarget.pinyin.split(',');
        const nextIndex = this.attempt.length;
        
        if (s === correctArr[nextIndex]) {
            this.attempt.push(s);
            // 檢查是否拼完目前的字
            if (this.attempt.length === correctArr.length) {
                this.isSuccess = true;
                
                // 如果還有下一個字，1.5秒後切換
                if (this.wordIndex < this.currentStory.words.length - 1) {
                    setTimeout(() => {
                        this.wordIndex++;
                        this.resetTurn();
                    }, 1500);
                } else {
                    alert("全部拼對了！你太棒了！");
                }
            }
        } else {
            // 答錯時的小回饋
            alert("不對喔，再試試看！");
        }
    }
}
   mounted() {
    const sheetID = '你的試算表ID';
    const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;
    
    fetch(url)
        .then(res => res.text())
        .then(data => {
            // 解析 Google Json 格式
            const r = JSON.parse(data.substring(47, data.length - 2));
            console.log("抓到的資料：", r.table.rows);
            // 這裡將 rows 的資料存入 this.stories
        });
}
}).mount('#app');
</script>
</body>
</html>
